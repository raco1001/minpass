# 1) C4 Level 1 – System Context

```mermaid
flowchart LR
  %% Actors
  U[("User<br/>(직장인/성인)")]:::actor

  %% System boundary
  subgraph SYS["MinPass (AI Productivity SaaS)"]
    CORE["(MinPass Core<br/>AI 일정·성장 SaaS)"]:::system
  end

  %% External systems
  GCal["(Google Calendar/Tasks)"]:::external
  Notion["(Notion)"]:::external
  Push["(Push Service<br/>(FCM/APNs))"]:::external
  LLM[("LLM Provider<br/>OpenAI/Gemini")]:::external
  OS["(Mobile OS Services<br/>음성/위치/백그라운드)"]:::external

  %% Relations
  U -- "음성/텍스트 명령, 대시보드 사용" --> CORE
  CORE -- "양방향 동기화" --> GCal
  CORE -- "단방향 동기화(Should)" --> Notion
  CORE -- "알림 전송" --> Push
  CORE -- "NLU/요약/추천" --> LLM
  CORE -- "수면/위치/앱 사용 이벤트" --> OS

  classDef actor fill:#e8fff5,stroke:#0aa,stroke-width:1px;
  classDef system fill:#eef3ff,stroke:#4c6ef5,stroke-width:1.2px;
  classDef external fill:#fff7e6,stroke:#f59f00,stroke-width:1px;

```

---

# 2) C4 Level 2 – Container Diagram

```mermaid
flowchart LR
  U["User"]:::actor

  subgraph MINPASS[MinPass]
    subgraph Client[Clients]
      Mobile["(Mobile Agent<br/>(iOS/Android)<br/>RN/Flutter)"]:::container
      Web["Web Dashboard<br/>(Next.js/React)"]:::container
    end

    subgraph API["Backend (API & Services)"]
      BFF["API Gateway / BFF<br/>(NestJS)"]:::container
      SCH["Scheduler & Sync Worker<br/>(NestJS worker)"]:::container
      AI["AI Service<br/>(Python/Node)"]:::container
      NOTIF["Notification Service<br/>(Push/Event Routing)"]:::container
    end

    subgraph DATA[Data Layer]
      DB[("Postgres (Supabase)")]:::db
      CACHE[("Redis<br/>Cache/Queue")]:::infra
      OBJ[("Object Storage (Supabase)")]:::infra
    end
  end

  %% Externals
  GCal["Google Calendar/Tasks"]:::external
  Notion[("Notion API")]:::external
  Push[("FCM/APNs")]:::external
  LLM[("LLM Provider")]:::external
  OS[("Mobile OS Services")]:::external

  %% Relations
  U --> Mobile
  U --> Web

  Mobile --> BFF
  Web --> BFF
  BFF --> DB
  BFF --> CACHE
  BFF --> AI
  SCH --> GCal
  SCH --> DB
  SCH --> CACHE
  AI --> LLM
  NOTIF --> Push
  Mobile --> OS
  SCH --> Notion
  NOTIF --> Mobile
  BFF --> OBJ

  classDef actor fill:#e8fff5,stroke:#0aa;
  classDef container fill:#eef3ff,stroke:#4c6ef5;
  classDef db fill:#f0fff4,stroke:#2b8a3e;
  classDef infra fill:#f8f9fa,stroke:#868e96,stroke-dasharray: 3 3;
  classDef external fill:#fff7e6,stroke:#f59f00;

```

---

# 3) C4 Level 3 – Component Diagram (Backend)

```mermaid
flowchart TB
  subgraph API["Backend (API & Services)"]
    AUTH["Auth Controller<br/>(JWT/OAuth, 동의/권한)"]:::comp
    SCHEDAPI["Schedule API<br/>(일정/퀘스트 CRUD, 충돌 검사)"]:::comp
    BRIDGEAPI["Bridge API<br/>(질문/응답/리포트)"]:::comp
    ACTING["Activity Ingest API<br/>(수면/위치/앱/결제메타 수집)"]:::comp

    SYNCW["Sync Worker<br/>(GCal 동기화/재스케줄/리트라이)"]:::comp
    PRED["Prediction / Overload Engine<br/>(소요시간 예측/과부하)"]:::comp
    RESCH["Smart Rescheduler<br/>(대체 시간/블록 제안)"]:::comp
    BRIDGEGEN["Bridge Generator<br/>(질문/인사이트 생성)"]:::comp
    AICLIENT["AI Client Lib<br/>(LLM 호출/프롬프트)"]:::comp
    NOTIF["Notification Router<br/>(푸시/이메일 라우팅)"]:::comp
  end

  %% Dependencies
  SCHEDAPI --> SYNCW
  SCHEDAPI --> PRED
  PRED --> AICLIENT
  RESCH --> SCHEDAPI
  BRIDGEAPI --> BRIDGEGEN
  BRIDGEGEN --> AICLIENT
  ACTING --> PRED
  NOTIF --> BRIDGEAPI

  classDef comp fill:#eef3ff,stroke:#4c6ef5;

```

---

# 4) Deployment (간단 뷰)

```mermaid
flowchart LR
  subgraph CLOUD[VPC / Cloud]
    subgraph APP["App Cluster (K8s/ECS)"]
      BFF["API/BFF Pods<br/>(NestJS)"]:::node
      WORKERS["Workers<br/>(Scheduler/Sync/Notif)"]:::node
      AISVC["AI Service<br/>(Python/Node)"]:::node
    end
    subgraph DATA[Data Layer]
      DB[("Postgres (Supabase)")]:::db
      REDIS[("Redis")]:::node
      OBJ[("Object Storage")]:::node
    end
  end

  subgraph CLIENTS[Client Devices]
    MOBILE["Mobile App<br/>(iOS/Android)"]:::client
    WEB["Web App<br/>(Next.js)"]:::client
  end

  MOBILE -->|HTTPS| BFF
  WEB -->|HTTPS| BFF
  BFF -->|SQL| DB
  WORKERS -->|SQL| DB
  BFF --> REDIS
  WORKERS --> REDIS
  WORKERS -->|HTTPS| OBJ
  AISVC --> BFF

  classDef node fill:#eef3ff,stroke:#4c6ef5;
  classDef db fill:#f0fff4,stroke:#2b8a3e;
  classDef client fill:#e8fff5,stroke:#0aa;

```

---

## 핵심 요약

- **경계**: Mobile/Web ↔ BFF ↔ Services(Worker/AI/Notif) ↔ Data(Postgres/Redis/Object)
- **동기화 패턴**: 사용자 액션은 **즉시응답 + 비동기 동기화**(큐/워커, 재시도/백오프)
- **LLM 비용/지연 가드**: 캐싱(요약/템플릿), 토큰 한도, 중요 경로는 규칙 기반 폴백
- **개인정보 처리**: 동의기반 옵트인 데이터만 수집, 민감 필드 마스킹/분리 저장
- **관측성**: 분산 트레이싱(trace-id), p95/오류율/큐 적재량 대시보드
