- **형식:** OpenAPI 3.0 JSON/YAML
- **내용:** 엔드포인트, Request/Response 구조, 인증 방식, 에러 코드

### 1. 리턴 형식

### 정상

- `data`: 단일 객체 또는 배열. 배열일 때 `meta.cursor/next_cursor/page_size` 사용.
- `total`: 비용 큰 카운트는 **기본 null**. 필요 시 `?include_total=true`.
- `elapsed_ms`: 서버 처리 시간(관측성).

```json
{
  "success": true,
  "data": {
    /* 리소스 or 배열 */
  },
  "meta": {
    "total": null,
    "page_size": 50,
    "cursor": "eyJvZmZzZXQiOjE3fQ==", // optional
    "next_cursor": "eyJvZmZzZXQiOjY3fQ==", // optional
    "elapsed_ms": 12
  },
  "request": {
    "id": "req_01HZY0YX9W6E9P9K2N3Q2Z2V9G",
    "received_at": "2025-09-18T12:34:56.789Z",
    "idempotency_key": "idem_abc123",
    "trace_id": "tr_9c1e0f8e..."
  },
  "version": "v1"
}
```

### 에러

- `type/title/status`는 RFC 7807 규격 키.
- `code`: 내부 비즈니스 에러 코드(대문자 스네이크).
- `errors[]`: 필드 단위 검증 실패 목록(폼·DTO 검증에 유용).
- `retriable/retry_after`: 클라이언트 재시도 정책에 직접 사용.

```json
{
  "success": false,
  "error": {
    "type": "https://api.minpass.dev/errors/schedule-conflict",
    "title": "Schedule conflict",
    "status": 409,
    "code": "SCHEDULE_CONFLICT",
    "detail": "The requested time overlaps with another event.",
    "instance": "/v1/schedules",
    "errors": [
      {
        "field": "start_ts",
        "issue": "overlaps",
        "value": "2025-09-19T09:00:00Z"
      }
    ],
    "retriable": false,
    "retry_after": null,
    "suggestion": "Try one of the suggested timeslots.",
    "links": {
      "doc": "https://docs.minpass.dev/errors#SCHEDULE_CONFLICT"
    }
  },
  "request": {
    "id": "req_01HZY0...",
    "trace_id": "tr_9c1e0...",
    "received_at": "2025-09-18T12:35:00.123Z"
  },
  "version": "v1"
}
```

### 로그

- **PII 금지 기본값**: `privacy.pii=false`. PII가 섞일 가능성 있으면 **사전 마스킹** 후 전송.
- 서버 수집 엔드포인트 예시: `POST /v1/logs/events` (배치 지원).

```json
{
  "ts": "2025-09-18T12:36:10.001Z",
  "level": "INFO",
  "event": "bridge.completed",
  "user_id": "usr_8c2a...",
  "session_id": "sess_a91f...",
  "trace_id": "tr_9c1e0...",
  "source": "mobile", // mobile | web | server | worker
  "device": {
    "platform": "ios",
    "version": "17.4",
    "app_version": "1.2.3",
    "model": "iPhone15,3"
  },
  "metrics": { "duration_ms": 2845 },
  "context": {
    "bridge_score": 4,
    "questions": 5
  },
  "privacy": {
    "pii": false,
    "fields_redacted": []
  }
}
```

### 배치

```json
{
  "success": true,
  "data": {
    "accepted": 2,
    "rejected": 0
  },
  "meta": {},
  "request": { "id": "req_..." },
  "version": "v1"
}
```

4. 공통 헤더 & 규약

**요청 헤더**

Authorization: Bearer <token>

Idempotency-Key (POST/PUT/DELETE에서 멱등성 보장)

X-Trace-Id (선택, 없으면 서버 생성)

Accept-Language (ko-KR, en-US)

**응답 헤더**

X-Request-Id, X-Trace-Id

Retry-After (429/503 시)

날짜/시간 파라미터: 항상 UTC ISO-8601, 타임존 변환은 클라이언트 책임

페이지네이션 쿼리: ?cursor=...&limit=50

선택 필드 확장: ?include=attendees,quests

필드 선택: ?fields=id,title,start_ts,end_ts

---

5. 타입/스키마(참고용 TypeScript)

```typescript
type Success<T> = {
  success: true
  data: T
  meta?: {
    total?: number | null
    page_size?: number
    cursor?: string | null
    next_cursor?: string | null
    elapsed_ms?: number
  }
  request: {
    id: string
    received_at: string
    idempotency_key?: string
    trace_id?: string
  }
  version: string
}

type FieldError = { field: string; issue: string; value?: unknown }

type Problem = {
  type: string
  title: string
  status: number
  code: string
  detail?: string
  instance?: string
  errors?: FieldError[]
  retriable?: boolean
  retry_after?: number | null
  suggestion?: string
  links?: Record<string, string>
}

type Failure = {
  success: false
  error: Problem
  request: { id: string; trace_id?: string; received_at: string }
  version: string
}

type LogEvent = {
  ts: string
  level: 'DEBUG' | 'INFO' | 'WARN' | 'ERROR'
  event: string
  user_id?: string | null
  session_id?: string | null
  trace_id?: string | null
  source: 'mobile' | 'web' | 'server' | 'worker'
  device?: {
    platform?: string
    version?: string
    app_version?: string
    model?: string
  }
  metrics?: Record<string, number>
  context?: Record<string, unknown>
  privacy?: { pii: boolean; fields_redacted?: string[] }
}
```

---

6. 샘플: 일정 생성 성공/실패

성공

```json
{
  "success": true,
  "data": {
    "id": "sch_01J0...",
    "title": "팀 회의",
    "start_ts": "2025-09-19T06:00:00Z",
    "end_ts": "2025-09-19T07:00:00Z",
    "source": "APP",
    "status": "CONFIRMED"
  },
  "meta": { "elapsed_ms": 18 },
  "request": {
    "id": "req_01HZY0...",
    "received_at": "2025-09-18T12:40:00.000Z"
  },
  "version": "v1"
}
```

충돌 에러

```json
{
  "success": false,
  "error": {
    "type": "https://api.minpass.dev/errors/schedule-conflict",
    "title": "Schedule conflict",
    "status": 409,
    "code": "SCHEDULE_CONFLICT",
    "detail": "Overlaps with event sch_01I9...",
    "errors": [{ "field": "start_ts", "issue": "overlaps" }],
    "retriable": false,
    "suggestion": "Use ?autoreschedule=true to get suggestions",
    "links": { "doc": "https://docs.minpass.dev/schedules#conflict" }
  },
  "request": {
    "id": "req_01HZY0...",
    "received_at": "2025-09-18T12:40:01.234Z"
  },
  "version": "v1"
}
```

## 2. API 목록

| 리소스                   | 엔드포인트                           | 메서드 | 설명                                      | 비고                      |
| ------------------------ | ------------------------------------ | ------ | ----------------------------------------- | ------------------------- |
| **Auth & User**          | `POST /v1/auth/login`                | POST   | 사용자 로그인(OAuth 토큰 교환 포함)       | idempotency-key 필요 없음 |
|                          | `GET /v1/users/me`                   | GET    | 내 프로필 조회                            |                           |
|                          | `PATCH /v1/users/me`                 | PATCH  | 프로필 업데이트                           |                           |
| **Consent**              | `GET /v1/consents`                   | GET    | 사용자 동의 현황 조회                     |                           |
|                          | `POST /v1/consents`                  | POST   | 새로운 동의 저장                          | GDPR/KISA 플래그 포함     |
| **Schedules**            | `GET /v1/schedules`                  | GET    | 일정 리스트 조회 (커서 기반 페이지네이션) | `?start=…&end=…` 지원     |
|                          | `POST /v1/schedules`                 | POST   | 일정 생성                                 | Google sync 옵션          |
|                          | `PATCH /v1/schedules/{id}`           | PATCH  | 일정 수정                                 | 충돌 시 409               |
|                          | `DELETE /v1/schedules/{id}`          | DELETE | 일정 삭제                                 | soft delete 고려          |
| **Quests**               | `GET /v1/schedules/{id}/quests`      | GET    | 일정에 포함된 퀘스트 조회                 |                           |
|                          | `POST /v1/schedules/{id}/quests`     | POST   | 퀘스트 추가                               | Deepwork 모드 포함        |
|                          | `PATCH /v1/quests/{id}`              | PATCH  | 퀘스트 업데이트                           | outcome 변경 등           |
| **Activity Logs**        | `POST /v1/activities`                | POST   | 활동 로그 수집(위치/수면/앱사용 등)       | 배치 업로드 지원          |
|                          | `GET /v1/activities`                 | GET    | 내 활동 로그 조회                         |                           |
| **Bridge Session**       | `POST /v1/bridge-entries`            | POST   | 브리지 회고 저장                          |                           |
|                          | `GET /v1/bridge-entries`             | GET    | 브리지 기록 조회                          |                           |
| **Integrations**         | `POST /v1/integrations/google`       | POST   | Google 계정 연동 시작                     | OAuth redirect            |
|                          | `DELETE /v1/integrations/{provider}` | DELETE | 연동 해제                                 |                           |
| **Notifications**        | `GET /v1/notifications`              | GET    | 알림 목록 조회                            |                           |
|                          | `POST /v1/notifications/test`        | POST   | 테스트 알림 발송                          | 디버그용                  |
| **Dashboard (Ontology)** | `GET /v1/dashboard/ontology`         | GET    | 온톨로지 맵 조회                          | 초기 버전 read-only       |
|                          | `POST /v1/dashboard/ontology/nodes`  | POST   | 사용자 정의 노드 생성                     | 선택적                    |
